#!/usr/bin/env ruby

require "fileutils"

def usage
  $stderr.puts "USAGE:"
  $stderr.puts "  For AWS: create_micro_bosh_yml NAME aws ACCESS_KEY SECRET_KEY REGION KEYNAME IP_ADDRESS RAW_PASSWORD"
  $stderr.puts "  For OpenStack: create_micro_bosh_yml NAME openstack NAME OS_USERNAME OS_PASSWORD OS_TENANT_NAME OS_AUTH_URL KEYNAME RAW_PASSWORD"
  exit 1
end

name     = ARGV.shift
provider = ARGV.shift
usage unless provider
case provider.upcase
  when "AWS"
    access_key   = ARGV.shift
    secret_key   = ARGV.shift
    region       = ARGV.shift
    keypair_name = ARGV.shift
    ipaddress    = ARGV.shift
    password     = ARGV.shift
  when "OPENSTACK"
    os_username    = ARGV.shift
    os_password    = ARGV.shift
    os_tenant_name = ARGV.shift
    os_auth_url    = ARGV.shift
    keypair_name   = ARGV.shift
    password       = ARGV.shift
  else usage
end
usage unless keypair_name

def salted_password(password)
  `mkpasswd -m sha-512 '#{password}'`.strip
end

def aws_config_yml(name, access_key, secret_key, region, key_name, ipaddress, salted_password, options={})

  # sanity checks
  raise "Something went wrong. This is not a salted password: " +
        "#{salted_password}" unless salted_password.start_with?("$")
  require 'ipaddr'
  IPAddr.new ipaddress

  availability_zone = options[:availability_zone] || "#{region}a"
  kernel_id         = options[:kernel_id]
  image_id          = options[:image_id] || 'ami-0743ef6e' # TODO not currently used in micro_bosh.yml
  stemcell_disk     = options[:stemcell_disk] || 4096
  security_group    = options[:security_group] || 'default'             
  instance_type     = options[:instance_type] || 'm1.small'
  unless kernel_id
    kernel_id = case region
    when 'ap-northeast-1' then 'aki-d409a2d5'
    when 'ap-southeast-1' then 'aki-11d5aa43'
    when 'eu-west-1' then 'aki-4feec43b'
    when 'sa-east-1' then 'aki-d63ce3cb'
    when 'us-east-1' then 'aki-b4aa75dd' # or should it be aki-427d952b ?
    when 'us-west-1' then 'aki-9ba0f1de'
    when 'us-west-2' then 'aki-ace26f9c'
    else raise "Unknown aws region #{region}"
    end
  end
  stemcell_disk     = options[:stemcell_disk] || 4096
  security_group    = options[:security_group] || 'default'
  instance_type     = options[:instance_type] || 'm1.small'
  <<-YAML
---
name: #{name}

env:
  bosh:
    password: #{salted_password}

logging:
  level: DEBUG

network:
  type: dynamic
  ip: #{ipaddress}

resources:
  cloud_properties:
    instance_type: #{instance_type}
    root_device_name: /dev/sda1
    availability_zone: #{availability_zone}

cloud:
  plugin: aws
  properties:
    aws:
      access_key_id:     #{access_key}
      secret_access_key: #{secret_key}
      ec2_endpoint: ec2.#{region}.amazonaws.com
      default_key_name: #{key_name}
      default_security_groups: ["#{security_group}"]
      ec2_private_key: /home/vcap/.ssh/#{key_name}.pem
    stemcell:
      image_id: #{image_id}
      kernel_id: #{kernel_id}
      root_device_name: /dev/sda1
      disk: #{stemcell_disk}
    agent:
      mbus: http://vcap:b00tstrap@0.0.0.0:6868
YAML
end

def openstack_config_yml(name, username, api_key, tenant, auth_url, key_name, salted_password, options={})

  security_group = options[:security_group] || 'default'
  instance_type  = options[:instance_type] || 'm1.small'
  <<-YAML
---
name: #{name}

env:
  bosh:
    password: #{salted_password}

logging:
  level: DEBUG

network:
  type: dynamic

resources:
  cloud_properties:
    instance_type: #{instance_type}

cloud:
  plugin: openstack
  properties:
    openstack:
      auth_url: #{auth_url}
      username: #{username}
      api_key:  #{api_key}
      tenant:   #{tenant}
      default_key_name: #{key_name}
      default_security_groups: ["#{security_group}"]
      openstack_private_key: /home/vcap/.ssh/#{key_name}.pem
      create_stemcell_image: upload
    registry:
      endpoint: http://admin:admin@localhost:25889
      user: admin
      password: admin
YAML
end


salty = salted_password(password)
yml = case provider.upcase
  when "AWS"
    aws_config_yml(name, access_key, secret_key, region, keypair_name, ipaddress, salty, options={})
  when "OPENSTACK"
    openstack_config_yml(name, os_username, os_password, os_tenant_name, os_auth_url, keypair_name, salty, options={})
  else usage
end

deployment_dir = File.join("/var", "vcap", "deployments", name)
FileUtils.mkdir_p(deployment_dir)
micro_bosh_yml = File.join(deployment_dir, "micro_bosh.yml")
File.open(micro_bosh_yml, "w") { |f| f << yml }
$stderr.puts "Created #{micro_bosh_yml}..."
